<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
  <style>
    html, body, #cy {
      width: 100%;
      height: 100%;
      margin: 0;
    }
  </style>
</head>
<body>
  <div id="cy"></div>

  <script>
    const vscode = acquireVsCodeApi();

    window.addEventListener("message", event => {
      const data = event.data;

      const elements = [];

      elements.push({ data: { id: data.current.name } });

      data.upstream.forEach(u => {
        elements.push({ data: { id: u.name } });
        elements.push({ data: { source: u.name, target: data.current.name } });
      });

      data.downstream.forEach(d => {
        elements.push({ data: { id: d.name } });
        elements.push({ data: { source: data.current.name, target: d.name } });
      });

      const cy = cytoscape({
        container: document.getElementById("cy"),
        elements,
        style: [
          {
        selector: "node",
        style: {
          "label": "data(id)",
          "shape": "round-rectangle",
          "width": 200,
          "background-color": "#007acc",
          "color": "#fff",
          "text-valign": "center",
          "text-halign": "center",
          "padding": "10px"
        }
          },
          {
        selector: "edge",
        style: {
          "width": 2,
          "line-color": "#999",
          "curve-style": "bezier",
          "control-point-step-size": 40,
          "target-distance-from-node": 6,
          "line-cap": "round",
          "target-arrow-shape": "triangle",
          "target-arrow-color": "#999",
          "arrow-scale": 1.6
        }
          }
        ],
        layout: {
          name: "breadthfirst",
          directed: true,
          transform: (node, pos) => ({ x: pos.y, y: pos.x })
        }
      });

      cy.on("tap", "node", evt => {
        vscode.postMessage({ openFile: evt.target.id() + ".sql" });
      });
    });
  </script>
</body>
</html>
