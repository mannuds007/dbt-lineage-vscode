<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'none';
                 script-src {{cspSource}} 'nonce-{{nonce}}';
                 style-src {{cspSource}} 'unsafe-inline';">
  <title>DBT Lineage</title>
  <style>
    body, html { 
      background-color: #1e1e1e; 
      margin: 0; 
      padding: 0;
      overflow: hidden; 
      height: 100vh; 
      width: 100vw; 
    }
    #mynetwork { 
      width: 100%; 
      height: 100%; 
    }
  </style>
</head>

<body>

<div id="mynetwork"></div>

<!-- Load local vis-network library -->
<script src="{{visNetworkUri}}"></script>

<script nonce="{{nonce}}">
  const vscode = acquireVsCodeApi();
  let network = null;

  function render(data) {
    if (!data || !data.current) return;

    const nodes = [];
    const edges = [];
    const ids = new Set();

    // Track the longest name to calculate column width dynamically
    let maxNameLength = 0;

    function addNode(node, group) {
      if (!ids.has(node.name)) {
        ids.add(node.name);

        // 1. Update Max Length
        if (node.name.length > maxNameLength) {
          maxNameLength = node.name.length;
        }

        let colorConfig;
        let fontConfig = { color: "#ffffff", face: "monospace", size: 14 };

        if (group === 'current') {
          colorConfig = {
            background: "#005f87", border: "#00aaff",
            highlight: { background: "#0077aa", border: "#ffffff" }
          };
          fontConfig.size = 16;
          fontConfig.multi = 'md'; // allows markdown if needed, mostly for boldness
        } else {
          colorConfig = {
            background: "#2d2d2d", border: "#6E6E6E",
            highlight: { background: "#3d3d3d", border: "#6E6E6E" }
          };
        }

        nodes.push({
          id: node.name,
          label: node.name,
          group: group,
          shape: 'box',
          margin: 12,
          borderWidth: 2,
          shadow: true,
          color: colorConfig,
          font: fontConfig,
          data: { filePath: node.path }
        });
      }
    }

    // Build Data
    addNode(data.current, 'current');
    
    (data.upstream || []).forEach(u => {
      addNode(u, 'upstream');
      edges.push({ from: u.name, to: data.current.name });
    });
    
    (data.downstream || []).forEach(d => {
      addNode(d, 'downstream');
      edges.push({ from: data.current.name, to: d.name });
    });

    // 2. Calculate Dynamic Separation
    // Monospace font ~9px per char. Add buffer for margins/arrows.
    const charWidthPx = 9;
    const bufferPx = 120;
    const calculatedSeparation = (maxNameLength * charWidthPx) + bufferPx;

    // Ensure it's at least 300px
    const finalSeparation = Math.max(300, calculatedSeparation);

    const container = document.getElementById('mynetwork');
    const options = {
      layout: {
        hierarchical: {
          enabled: true,
          direction: 'LR',
          sortMethod: 'directed',
          levelSeparation: finalSeparation,
          nodeSpacing: 80
        }
      },
      edges: {
        arrows: { to: { enabled: true, scaleFactor: 0.5 } },
        width: 1,
        color: { color: "#808080", highlight: "#ffffff", hover: "#ffffff" },
        smooth: { enabled: true, type: "cubicBezier", forceDirection: "horizontal", roundness: 0.7 }
      },
      physics: { enabled: false },
      interaction: {
        hover: false, tooltipDelay: 200, zoomView: true, dragView: true, dragNodes: true
      }
    };

    if (network !== null) network.destroy();
    
    // Create Network
    network = new vis.Network(container, { nodes, edges }, options);

    // Disable hierarchical layout after stabilization allows user to drag nodes freely
    network.once("stabilizationIterationsDone", function () {
      network.setOptions({ layout: { hierarchical: { enabled: false } } });
    });
    
    // Fallback if stabilization is too fast or skipped
    setTimeout(() => {
      network.setOptions({ layout: { hierarchical: { enabled: false } } });
    }, 100);

    // --- CLICK INTERACTION ---
    network.on("doubleClick", function (params) {
      if (params.nodes.length > 0) {
        const nodeId = params.nodes[0];
        // vis-network stores data in a DataSet, but we can access our raw array here or get from dataset
        // Since we passed a raw array, we search it:
        const clickedNode = nodes.find(n => n.id === nodeId);

        if (clickedNode && clickedNode.data && clickedNode.data.filePath) {
           // Send message back to VS Code Extension
           vscode.postMessage({ openFile: clickedNode.data.filePath.replace(/\\\\/g, "/") });
        }
      }
    });
  }

  // Handle messages sent from extension.js
  window.addEventListener("message", event => {
    render(event.data);
  });
</script>
</body>
</html>